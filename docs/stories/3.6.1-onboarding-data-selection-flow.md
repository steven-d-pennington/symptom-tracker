# Story 3.6.1: Interactive Data Selection During Onboarding

Status: draft

**Priority:** HIGH
**Points:** 13

## Story

As a new user going through onboarding,
I want to select which symptoms, triggers, medications, and foods are relevant to me,
So that my dashboard only shows items I actually use and I feel in control of my data from day one.

## Context

Current implementation (Story 3.5.1) auto-populates ALL defaults for new users, which can feel overwhelming and impersonal. This story enhances the onboarding flow to let users actively choose what's relevant to them, creating a more personalized and intentional first experience.

## Acceptance Criteria

1. **AC3.6.1.1 — Add symptom selection step to onboarding:** Create new onboarding step after step 4 (Condition Step) for symptom selection, step displays all default symptoms organized by category (collapsible sections), categories collapsed by default to reduce visual overwhelm, user can expand categories to see symptoms within, each symptom has checkbox for selection, selected symptoms will be enabled in their account, step includes "Select All" and "Clear All" buttons for convenience. [Enhancement of Story 3.5.1]

2. **AC3.6.1.2 — Add search functionality to symptom selection:** Step includes search box at top of screen, search filters symptom list in real-time as user types, search looks in both symptom name and category, collapsed categories auto-expand if they contain matching symptoms, clear search button (X) appears when text is entered, search is case-insensitive and works with partial matches. [UX Enhancement]

3. **AC3.6.1.3 — Allow adding custom symptoms during onboarding:** If user searches for symptom that doesn't exist in defaults, show "Not found. Add '[search term]' as custom symptom?" prompt, clicking prompt opens inline form to create custom symptom with name pre-filled, form includes: name (pre-filled), category (dropdown), description (optional), new custom symptom is automatically selected/favorited, custom symptoms appear in selected list with distinct visual indicator. [Power User Feature]

4. **AC3.6.1.4 — Add trigger selection step to onboarding:** Create new onboarding step after symptom selection for trigger selection, same UX pattern as symptom selection: categories, search, add custom, default triggers organized by category (Environmental, Physical, Emotional, Dietary), step title: "Which triggers affect you?", step description: "Select triggers you want to track". [Consistency]

5. **AC3.6.1.5 — Add medication selection step to onboarding:** Create new onboarding step after trigger selection for medication selection, same UX pattern as symptoms/triggers, default medications organized by category (Over-the-Counter, Prescription, Topical, Natural/Alternative), step title: "What treatments do you use?", step description: "Select medications and treatments you want to track", medications can include both prescription and OTC treatments. [Consistency]

6. **AC3.6.1.6 — Add food selection step to onboarding:** Create new onboarding step after medication selection for food selection, same UX pattern as other steps, default foods organized by category (Dairy, Grains, Proteins, Vegetables, Fruits, Processed), step title: "Which foods do you want to track?", step description: "Select foods that might be triggers or that you eat frequently", includes note: "You can add more foods anytime from the food logging screen". [Consistency]

7. **AC3.6.1.7 — Update progress indicator for new steps:** Onboarding progress indicator updated to show new step count, steps numbered appropriately (e.g., if symptoms is step 5, triggers is 6, etc.), progress bar reflects correct completion percentage, user can see how many steps remain, back button allows returning to previous selection steps without losing selections. [UX Polish]

8. **AC3.6.1.8 — Skip functionality for each selection step:** Each selection step includes "Skip for now" button in top-right, skipping a step means NO items of that type are pre-selected (user starts with empty state), skipped steps can be completed later from Settings > Manage Data, skip action tracked in analytics for product insights, if user skips all 4 steps, show helpful message: "No problem! You can add items anytime from Settings". [User Agency]

9. **AC3.6.1.9 — Preserve selections if user goes back:** User selections preserved if they click back button, example: if user selects 5 symptoms, goes back, then forward again, those 5 symptoms still selected, selections stored in onboarding context/state (not yet committed to database), only committed to database when onboarding completes, validation: user must select at least 1 item OR explicitly skip (can't just click Next with no selections). [Data Integrity]

10. **AC3.6.1.10 — Batch creation on onboarding completion:** When user completes onboarding, create all selected items in single batch operation, selected default items: mark as isDefault: true AND isEnabled: true, custom items created during onboarding: mark as isDefault: false AND isFavorite: true, unselected defaults: NOT created in database (true opt-in model), show loading state during batch creation: "Setting up your dashboard...", on completion, redirect to dashboard with success message. [Performance & UX]

11. **AC3.6.1.11 — Responsive design for all selection steps:** Selection steps work on mobile, tablet, and desktop, on mobile: categories stack vertically, search box full width, touch targets minimum 44x44px, on tablet: 2-column grid for symptom checkboxes within categories, on desktop: 3-column grid for maximum density, collapsible categories use smooth animations, entire step is scrollable with sticky search bar at top. [Accessibility & Mobile-First]

12. **AC3.6.1.12 — Analytics tracking for onboarding selections:** Track which defaults users select most frequently, track which categories are most expanded/explored, track how many custom items are added during onboarding, track skip rate per step, analytics data helps improve default data sets over time, track average time spent on each selection step. [Product Intelligence]

## Tasks / Subtasks

- [ ] Task 1: Design data structure for onboarding selections (AC: #3.6.1.9, #3.6.1.10)
  - [ ] 1.1: Create TypeScript interfaces for onboarding selection state
  - [ ] 1.2: Define OnboardingSelections type with fields: symptoms, triggers, medications, foods
  - [ ] 1.3: Each field contains array of: { id?, name, category, isDefault, isCustom }
  - [ ] 1.4: Create React context `OnboardingSelectionsContext` to hold state across steps
  - [ ] 1.5: Context provides: selections state, addItem(), removeItem(), clearAll(), selectAll() methods
  - [ ] 1.6: Context persists to sessionStorage for page refresh resilience

- [ ] Task 2: Create reusable SelectionStep component (AC: #3.6.1.1, #3.6.1.2, #3.6.1.3)
  - [ ] 2.1: Create `src/app/onboarding/components/SelectionStep.tsx` component
  - [ ] 2.2: Props: { type: 'symptom' | 'trigger' | 'medication' | 'food', title, description, defaultItems, onNext, onSkip, onBack }
  - [ ] 2.3: Component renders: title, description, search box, category sections, action buttons
  - [ ] 2.4: Search functionality filters items in real-time
  - [ ] 2.5: Categories collapsible with chevron icon (lucide-react ChevronDown/ChevronUp)
  - [ ] 2.6: Checkbox for each item with label (WCAG compliant)
  - [ ] 2.7: "Not found" prompt appears when search has no results
  - [ ] 2.8: Clicking "Add custom" opens inline form (name, category, description)
  - [ ] 2.9: Form validates and creates item in context (not yet in DB)
  - [ ] 2.10: Custom items appear with badge: "Custom" in blue

- [ ] Task 3: Create symptom selection step (AC: #3.6.1.1, #3.6.1.2, #3.6.1.3)
  - [ ] 3.1: Create `src/app/onboarding/components/SymptomSelectionStep.tsx`
  - [ ] 3.2: Use SelectionStep component with type="symptom"
  - [ ] 3.3: Load DEFAULT_SYMPTOMS from `src/lib/data/defaultData.ts`
  - [ ] 3.4: Organize symptoms by category: Pain, Skin Changes, Discharge, Inflammation, etc.
  - [ ] 3.5: Title: "Which symptoms do you experience?"
  - [ ] 3.6: Description: "Select symptoms you want to track. You can add more later."
  - [ ] 3.7: Implement "Select All" and "Clear All" buttons
  - [ ] 3.8: Wire up to OnboardingSelectionsContext
  - [ ] 3.9: Next button validates: at least 1 selected OR user clicked Skip

- [ ] Task 4: Create trigger selection step (AC: #3.6.1.4)
  - [ ] 4.1: Create `src/app/onboarding/components/TriggerSelectionStep.tsx`
  - [ ] 4.2: Use SelectionStep component with type="trigger"
  - [ ] 4.3: Load DEFAULT_TRIGGERS from defaultData.ts
  - [ ] 4.4: Categories: Environmental, Physical, Emotional, Dietary
  - [ ] 4.5: Title: "Which triggers affect you?"
  - [ ] 4.6: Follow same patterns as symptom selection
  - [ ] 4.7: Wire to context, add validation

- [ ] Task 5: Create medication selection step (AC: #3.6.1.5)
  - [ ] 5.1: Create `src/app/onboarding/components/MedicationSelectionStep.tsx`
  - [ ] 5.2: Use SelectionStep component with type="medication"
  - [ ] 5.3: Load DEFAULT_MEDICATIONS from defaultData.ts
  - [ ] 5.4: Categories: Over-the-Counter, Prescription, Topical, Natural/Alternative
  - [ ] 5.5: Title: "What treatments do you use?"
  - [ ] 5.6: Follow same patterns
  - [ ] 5.7: Wire to context

- [ ] Task 6: Create food selection step (AC: #3.6.1.6)
  - [ ] 6.1: Create `src/app/onboarding/components/FoodSelectionStep.tsx`
  - [ ] 6.2: Use SelectionStep component with type="food"
  - [ ] 6.3: Load DEFAULT_FOODS from defaultData.ts
  - [ ] 6.4: Categories: Dairy, Grains, Proteins, Vegetables, Fruits, Processed
  - [ ] 6.5: Title: "Which foods do you want to track?"
  - [ ] 6.6: Description includes helpful note about adding more foods later
  - [ ] 6.7: Follow same patterns
  - [ ] 6.8: Wire to context

- [ ] Task 7: Update OnboardingFlow component (AC: #3.6.1.7, #3.6.1.8, #3.6.1.10)
  - [ ] 7.1: Update `src/app/onboarding/components/OnboardingFlow.tsx`
  - [ ] 7.2: Add new steps after ConditionStep (step 4):
    - Step 5: SymptomSelectionStep
    - Step 6: TriggerSelectionStep
    - Step 7: MedicationSelectionStep
    - Step 8: FoodSelectionStep
  - [ ] 7.3: Update step indices and total step count
  - [ ] 7.4: Update progress indicator to reflect new total
  - [ ] 7.5: Implement skip functionality: track skipped steps, allow proceeding without selections
  - [ ] 7.6: Add batch creation logic to completion handler:
    - Call bulkCreate APIs for each data type
    - Pass isDefault and isEnabled flags appropriately
    - Show "Setting up your dashboard..." loading state
    - Handle errors gracefully (log but don't block)
  - [ ] 7.7: Update completion redirect to show success toast

- [ ] Task 8: Update progress indicator (AC: #3.6.1.7)
  - [ ] 8.1: Update `src/app/onboarding/components/ProgressIndicator.tsx`
  - [ ] 8.2: Component should accept totalSteps as prop (now 8 or 9 instead of 4)
  - [ ] 8.3: Calculate progress percentage: (currentStep / totalSteps) * 100
  - [ ] 8.4: Show step number: "Step X of Y"
  - [ ] 8.5: Progress bar fills proportionally
  - [ ] 8.6: Test with updated step count

- [ ] Task 9: Update onboarding utilities (AC: #3.6.1.9)
  - [ ] 9.1: Update `src/app/onboarding/utils/storage.ts` if needed for selection persistence
  - [ ] 9.2: Update `src/app/onboarding/hooks/useOnboarding.tsx` to support new steps
  - [ ] 9.3: Ensure back button preserves selections across all new steps
  - [ ] 9.4: Add validation: can't proceed without selection unless Skip clicked
  - [ ] 9.5: Clear onboarding data from sessionStorage after successful completion

- [ ] Task 10: Implement responsive layouts (AC: #3.6.1.11)
  - [ ] 10.1: SelectionStep uses CSS Grid with responsive columns
  - [ ] 10.2: Mobile: 1 column, full width search, stack categories
  - [ ] 10.3: Tablet: 2 columns for items within categories
  - [ ] 10.4: Desktop: 3 columns for maximum density
  - [ ] 10.5: Sticky search bar at top of scrollable area
  - [ ] 10.6: Touch targets minimum 44x44px for mobile (checkboxes, buttons)
  - [ ] 10.7: Category expand/collapse animations smooth (Framer Motion or CSS transitions)
  - [ ] 10.8: Test on iPhone, Android tablet, desktop

- [ ] Task 11: Add analytics tracking (AC: #3.6.1.12)
  - [ ] 11.1: Use existing UX instrumentation system from useUxInstrumentation hook
  - [ ] 11.2: Track events: onboarding.symptom_selection, onboarding.trigger_selection, etc.
  - [ ] 11.3: Event payload includes: selectedCount, customCount, skipped (boolean), timeSpentMs
  - [ ] 11.4: Track most popular defaults: aggregate by symptom/trigger/etc. ID
  - [ ] 11.5: Track most expanded categories
  - [ ] 11.6: Track search queries (anonymized)
  - [ ] 11.7: Track custom item creation: count and categories
  - [ ] 11.8: Track step skip rate

- [ ] Task 12: Update user initialization service (AC: #3.6.1.10)
  - [ ] 12.1: Update `src/lib/services/userInitialization.ts`
  - [ ] 12.2: Refactor initializeUserDefaults() to accept optional selections parameter
  - [ ] 12.3: If selections provided, create ONLY selected items
  - [ ] 12.4: If no selections provided, fall back to old behavior (create all defaults)
  - [ ] 12.5: Signature: `initializeUserDefaults(userId: string, selections?: OnboardingSelections): Promise<InitializationResult>`
  - [ ] 12.6: Update bulkCreate calls to set isEnabled: true for selected defaults
  - [ ] 12.7: Update bulkCreate calls to set isFavorite: true for custom items
  - [ ] 12.8: Return detailed result: { success, symptomsCreated, triggersCreated, etc. }

- [ ] Task 13: Update existing tests (AC: All)
  - [ ] 13.1: Update onboarding flow tests to expect new steps
  - [ ] 13.2: Create tests for SelectionStep component
  - [ ] 13.3: Test search functionality
  - [ ] 13.4: Test custom item creation
  - [ ] 13.5: Test skip functionality
  - [ ] 13.6: Test back button preservation
  - [ ] 13.7: Test batch creation on completion
  - [ ] 13.8: Test responsive layouts (viewport testing)

- [ ] Task 14: Update documentation (AC: All)
  - [ ] 14.1: Update docs/onboarding-flow.md to describe new steps
  - [ ] 14.2: Add screenshots to docs/images/ for each new step
  - [ ] 14.3: Update README if onboarding flow is documented there
  - [ ] 14.4: Document OnboardingSelectionsContext API
  - [ ] 14.5: Add JSDoc comments to new components

- [ ] Task 15: Migration and backwards compatibility (AC: #3.6.1.10)
  - [ ] 15.1: Existing users (already onboarded) not affected - keep their data
  - [ ] 15.2: New feature flag: ONBOARDING_SELECTION_FLOW (default: true)
  - [ ] 15.3: If flag disabled, fall back to old auto-populate behavior
  - [ ] 15.4: If user closes browser mid-onboarding, selections persist in sessionStorage
  - [ ] 15.5: Clear sessionStorage after 24 hours (stale onboarding data)
  - [ ] 15.6: Test: fresh user, partial onboarding, completion, refresh, back button

## Technical Notes

**Component Reusability:**
- SelectionStep component is highly reusable across all 4 data types
- Props allow customization of titles, descriptions, and data sources
- Keep business logic in context, presentation logic in component

**Performance Considerations:**
- Batch creation on completion reduces DB operations from 100+ to 4
- Search uses debouncing (300ms) to avoid excessive re-renders
- Categories virtualized if > 50 items per category (future optimization)
- sessionStorage used for persistence (faster than IndexedDB for this use case)

**Accessibility:**
- All checkboxes have labels
- Search box has aria-label
- Category expand/collapse announces state changes
- Skip button clearly marked and keyboard accessible
- Form validation errors announced to screen readers

**Mobile Optimizations:**
- Touch targets 44x44px minimum (WCAG AAA)
- Sticky search bar prevents scrolling to top
- Smooth animations (but respects prefers-reduced-motion)
- Swipe gestures could be added later for category navigation

## Dependencies

- Depends on: Story 3.5.1 (defaults data structure exists)
- Blocks: None
- Related: Story 3.5.1 (enhances that functionality)

## Testing Strategy

**Unit Tests:**
- SelectionStep component: search, selection, custom creation
- OnboardingSelectionsContext: state management, methods
- Batch creation logic: correct flags, error handling

**Integration Tests:**
- Full onboarding flow: start to finish
- Back button: selections preserved
- Skip functionality: no data created
- Refresh mid-onboarding: selections persist

**E2E Tests:**
- New user onboarding: select items, create custom, complete
- Mobile onboarding: responsive layouts, touch interactions
- Skip all steps: empty dashboard, graceful experience

**Manual Testing:**
- Test on real mobile devices (iOS Safari, Android Chrome)
- Test with screen reader (VoiceOver, TalkBack)
- Test with 1 item, 10 items, 50 items (performance)
- Test slow network (loading states during batch creation)

## Definition of Done

- [ ] All 4 selection steps implemented and functional
- [ ] Search works across all steps
- [ ] Custom item creation works for all data types
- [ ] Skip functionality works
- [ ] Back button preserves selections
- [ ] Batch creation on completion successful
- [ ] Progress indicator accurate
- [ ] Responsive design works on mobile, tablet, desktop
- [ ] Analytics tracking implemented
- [ ] Tests passing (unit, integration, E2E)
- [ ] Code reviewed and approved
- [ ] Documentation updated
- [ ] QA sign-off
- [ ] Deployed to production

## Notes

**Why This Is Better Than Auto-Populate:**
1. **User Agency:** Users feel in control from day one
2. **Reduced Overwhelm:** Only see items they chose, not 50+ defaults
3. **Personalization:** Dashboard feels tailored to their needs
4. **Engagement:** Interactive selection is more engaging than passive onboarding
5. **Data Quality:** Users more likely to use items they explicitly selected

**Future Enhancements:**
- Smart suggestions based on condition type (from ConditionStep)
- Import selections from health records (FHIR integration)
- Popular items from community (anonymized aggregate data)
- Machine learning: predict useful defaults based on selections
- Bulk actions: "Select all pain symptoms", "Select all dietary triggers"

**Rollback Plan:**
- Feature flag allows instant rollback to old behavior
- No data migration needed (backwards compatible)
- Monitor skip rates - if > 50%, consider UX improvements

## Dev Agent Record

**Story Context File:** docs/stories/3.6.1-onboarding-data-selection-flow.context.xml

**Context Reference:** To be created by spec-context agent after story approval

**Implementation Notes:**
- Start with SelectionStep component (most reusable)
- Test thoroughly before adding to flow
- Consider animation polish as final step (not blocker)

---

**Story Created:** 2025-11-01
**Story Created By:** Dev Agent (via user request)
**Estimated Completion:** 2-3 sprints (13 points)
